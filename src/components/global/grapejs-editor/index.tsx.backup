
useEffect(() => {
    if (!editorRef.current) return

    const editor = grapesjs.init({
        container: editorRef.current,
        width: 'auto',
        height: 'calc(100vh - 60px)',
        fromElement: false, // Changed to false to use canvas config
        storageManager: false,
        panels: { defaults: [] },
        canvas: {
            styles: [
                // Add default styles to make elements visible
                'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap'
            ],
            scripts: [],
        },
        blockManager: {
            appendTo: '#blocks',
        },
        styleManager: {
            appendTo: '#styles-container',
        },
        selectorManager: {
            componentFirst: true,
        },
        deviceManager: {
            devices: [
                {
                    id: 'desktop',
                    name: 'Desktop',
                    width: '',
                },
                {
                    id: 'tablet',
                    name: 'Tablet',
                    width: '768px',
                },
                {
                    id: 'mobile',
                    name: 'Mobile',
                    width: '375px',
                },
            ],
        },
    })

    // Set up canvas with minimal initial content
    const wrapper = editor.getWrapper()
    wrapper.set({
        style: {
            'min-height': '100vh',
            'padding': '20px',
            'background': '#ffffff'
        }
    })

    // Add initial placeholder that can be easily deleted
    editor.addComponents(`
            <div data-gjs-type="text" style="padding: 40px; text-align: center; color: #999; border: 2px dashed #ddd; border-radius: 8px; margin: 20px;">
                <h2 style="margin: 0 0 10px 0; color: #666;">Start Building Your Page</h2>
                <p style="margin: 0;">Drag and drop blocks from the left panel to add content here</p>
            </div>
        `)

    // Configure StyleManager with comprehensive property sectors
    editor.StyleManager.addSector('general', {
        name: 'General',
        open: true,
        properties: [
            {
                property: 'display', type: 'select', defaults: 'block', list: [
                    { value: 'block', name: 'Block' },
                    { value: 'inline', name: 'Inline' },
                    { value: 'inline-block', name: 'Inline Block' },
                    { value: 'flex', name: 'Flex' },
                    { value: 'grid', name: 'Grid' },
                    { value: 'none', name: 'None' },
                ]
            },
            {
                property: 'position', type: 'select', list: [
                    { value: 'static', name: 'Static' },
                    { value: 'relative', name: 'Relative' },
                    { value: 'absolute', name: 'Absolute' },
                    { value: 'fixed', name: 'Fixed' },
                    { value: 'sticky', name: 'Sticky' },
                ]
            },
            {
                property: 'float', type: 'radio', defaults: 'none', list: [
                    { value: 'none', name: 'None' },
                    { value: 'left', name: 'Left' },
                    { value: 'right', name: 'Right' },
                ]
            },
        ],
    })

    editor.StyleManager.addSector('dimension', {
        name: 'Dimension',
        open: false,
        properties: [
            { property: 'width', type: 'integer', units: ['px', '%', 'vw', 'auto'] },
            { property: 'height', type: 'integer', units: ['px', '%', 'vh', 'auto'] },
            { property: 'max-width', type: 'integer', units: ['px', '%', 'vw', 'none'] },
            { property: 'max-height', type: 'integer', units: ['px', '%', 'vh', 'none'] },
            { property: 'min-width', type: 'integer', units: ['px', '%', 'vw'] },
            { property: 'min-height', type: 'integer', units: ['px', '%', 'vh'] },
        ],
    })

    editor.StyleManager.addSector('typography', {
        name: 'Typography',
        open: false,
        properties: [
            {
                property: 'font-family', type: 'select', list: [
                    { value: 'Arial, sans-serif', name: 'Arial' },
                    { value: 'Helvetica, sans-serif', name: 'Helvetica' },
                    { value: 'Georgia, serif', name: 'Georgia' },
                    { value: 'Times New Roman, serif', name: 'Times New Roman' },
                    { value: 'Courier New, monospace', name: 'Courier New' },
                ]
            },
            { property: 'font-size', type: 'integer', units: ['px', 'em', 'rem'], defaults: '16px' },
            {
                property: 'font-weight', type: 'select', list: [
                    { value: '300', name: 'Light' },
                    { value: '400', name: 'Normal' },
                    { value: '500', name: 'Medium' },
                    { value: '600', name: 'Semi-Bold' },
                    { value: '700', name: 'Bold' },
                ]
            },
            { property: 'line-height', type: 'integer', units: ['', 'px', 'em'] },
            { property: 'letter-spacing', type: 'integer', units: ['px', 'em'] },
            { property: 'color', type: 'color' },
            {
                property: 'text-align', type: 'radio', defaults: 'left', list: [
                    { value: 'left', name: 'Left', className: 'fa fa-align-left' },
                    { value: 'center', name: 'Center', className: 'fa fa-align-center' },
                    { value: 'right', name: 'Right', className: 'fa fa-align-right' },
                    { value: 'justify', name: 'Justify', className: 'fa fa-align-justify' },
                ]
            },
            {
                property: 'text-decoration', type: 'radio', list: [
                    { value: 'none', name: 'None' },
                    { value: 'underline', name: 'Underline' },
                    { value: 'line-through', name: 'Strike' },
                ]
            },
        ],
    })

    editor.StyleManager.addSector('decorations', {
        name: 'Decorations',
        open: false,
        properties: [
            { property: 'background-color', type: 'color' },
            { property: 'border-radius', type: 'integer', units: ['px', '%'] },
            {
                property: 'border', type: 'composite', properties: [
                    { property: 'border-width', type: 'integer', units: ['px'] },
                    {
                        property: 'border-style', type: 'select', list: [
                            { value: 'none', name: 'None' },
                            { value: 'solid', name: 'Solid' },
                            { value: 'dotted', name: 'Dotted' },
                            { value: 'dashed', name: 'Dashed' },
                        ]
                    },
                    { property: 'border-color', type: 'color' },
                ]
            },
            {
                property: 'box-shadow', type: 'stack', properties: [
                    { property: 'box-shadow-h', type: 'integer', units: ['px'] },
                    { property: 'box-shadow-v', type: 'integer', units: ['px'] },
                    { property: 'box-shadow-blur', type: 'integer', units: ['px'] },
                    { property: 'box-shadow-spread', type: 'integer', units: ['px'] },
                    { property: 'box-shadow-color', type: 'color' },
                ]
            },
            { property: 'opacity', type: 'slider', defaults: 1, min: 0, max: 1, step: 0.01 },
        ],
    })

    editor.StyleManager.addSector('spacing', {
        name: 'Spacing',
        open: false,
        properties: [
            {
                property: 'margin', type: 'composite', properties: [
                    { property: 'margin-top', type: 'integer', units: ['px', '%', 'auto'] },
                    { property: 'margin-right', type: 'integer', units: ['px', '%', 'auto'] },
                    { property: 'margin-bottom', type: 'integer', units: ['px', '%', 'auto'] },
                    { property: 'margin-left', type: 'integer', units: ['px', '%', 'auto'] },
                ]
            },
            {
                property: 'padding', type: 'composite', properties: [
                    { property: 'padding-top', type: 'integer', units: ['px', '%'] },
                    { property: 'padding-right', type: 'integer', units: ['px', '%'] },
                    { property: 'padding-bottom', type: 'integer', units: ['px', '%'] },
                    { property: 'padding-left', type: 'integer', units: ['px', '%'] },
                ]
            },
        ],
    })

    editor.StyleManager.addSector('flex', {
        name: 'Flex',
        open: false,
        properties: [
            {
                property: 'flex-direction', type: 'radio', defaults: 'row', list: [
                    { value: 'row', name: 'Row' },
                    { value: 'column', name: 'Column' },
                ]
            },
            {
                property: 'justify-content', type: 'select', list: [
                    { value: 'flex-start', name: 'Start' },
                    { value: 'center', name: 'Center' },
                    { value: 'flex-end', name: 'End' },
                    { value: 'space-between', name: 'Space Between' },
                    { value: 'space-around', name: 'Space Around' },
                ]
            },
            {
                property: 'align-items', type: 'select', list: [
                    { value: 'flex-start', name: 'Start' },
                    { value: 'center', name: 'Center' },
                    { value: 'flex-end', name: 'End' },
                    { value: 'stretch', name: 'Stretch' },
                ]
            },
            { property: 'gap', type: 'integer', units: ['px', 'rem'] },
        ],
    })

    // Register custom blocks with proper configuration
    customBlocks.forEach((block) => {
        try {
            editor.BlockManager.add(block.id, {
                label: block.label,
                content: block.content,
                category: { id: block.category, label: block.category },
                attributes: {
                    class: 'gjs-block',
                    title: block.label
                },
            })
            console.log(`✓ Registered block: ${block.label}`)
        } catch (error) {
            console.error(`✗ Failed to register block ${block.label}:`, error)
        }
    })

    // Log editor state for debugging
    console.log('GrapeJS Editor initialized:', {
        blocks: editor.BlockManager.getAll().length,
        components: editor.getComponents().length,
        wrapper: editor.getWrapper()
    })

    // Listen for component add events to debug
    editor.on('component:add', (component) => {
        console.log('Component added:', component.get('type'), component.toHTML())
    })

    editorInstanceRef.current = editor
    setEditorReady(true)

    // Cleanup
    return () => {
        editor.destroy()
    }
}, [])

const handleDeviceChange = (device: string) => {
    setActiveDevice(device)
    if (editorInstanceRef.current) {
        editorInstanceRef.current.setDevice(device)
    }
}

const handleUndo = () => {
    if (editorInstanceRef.current) {
        editorInstanceRef.current.UndoManager.undo()
    }
}

const handleRedo = () => {
    if (editorInstanceRef.current) {
        editorInstanceRef.current.UndoManager.redo()
    }
}

const handlePreview = () => {
    if (editorInstanceRef.current) {
        const commands = editorInstanceRef.current.Commands
        commands.run('preview')
    }
}

const handleSave = () => {
    // TODO: Implement save functionality
    if (editorInstanceRef.current) {
        const html = editorInstanceRef.current.getHtml()
        const css = editorInstanceRef.current.getCss()
        console.log('Save clicked - HTML:', html)
        console.log('Save clicked - CSS:', css)
    }
}

const handlePublish = () => {
    // TODO: Implement publish functionality
    console.log('Publish clicked - implement publish logic')
}
onClick = {() => handleDeviceChange('desktop')}
className = "gap-2"
    >
                        <Monitor className="w-4 h-4" />
                        <span className="hidden sm:inline">Desktop</span>
                    </Button >
                    <Button
                        variant={activeDevice === 'tablet' ? 'secondary' : 'ghost'}
                        size="sm"
                        onClick={() => handleDeviceChange('tablet')}
                        className="gap-2"
                    >
                        <Tablet className="w-4 h-4" />
                        <span className="hidden sm:inline">Tablet</span>
                    </Button>
                    <Button
                        variant={activeDevice === 'mobile' ? 'secondary' : 'ghost'}
                        size="sm"
                        onClick={() => handleDeviceChange('mobile')}
                        className="gap-2"
                    >
                        <Smartphone className="w-4 h-4" />
                        <span className="hidden sm:inline">Mobile</span>
                    </Button>
                </div >

    {/* Right Section - Actions */ }
    < div className = "flex items-center gap-2" >
                    <Button variant="ghost" size="sm" onClick={handleUndo}>
                        <Undo2 className="w-4 h-4" />
                    </Button>
                    <Button variant="ghost" size="sm" onClick={handleRedo}>
                        <Redo2 className="w-4 h-4" />
                    </Button>
                    <div className="w-px h-6 bg-border mx-1" />
                    <Button variant="ghost" size="sm" onClick={handlePreview}>
                        <Eye className="w-4 h-4 mr-2" />
                        Preview
                    </Button>
                    <Button variant="outline" size="sm" onClick={handleSave}>
                        <Save className="w-4 h-4 mr-2" />
                        Save
                    </Button>
                    <Button size="sm" onClick={handlePublish}>
                        <Rocket className="w-4 h-4 mr-2" />
                        Publish
                    </Button>
                </div >
            </div >

    {/* Editor Layout */ }
    < div className = "flex-1 flex overflow-hidden" >
        {/* Blocks Panel */ }
{
    editorReady && editorInstanceRef.current && (
        <BlocksPanel editor={editorInstanceRef.current} />
    )
}

{/* Editor Canvas */ }
<div className="flex-1 relative">
    <div id="gjs" ref={editorRef} className="h-full w-full"></div>
</div>

{/* Style Panel */ }
{
    editorReady && editorInstanceRef.current && (
        <StylePanel editor={editorInstanceRef.current} />
    )
}
            </div >
        </div >
    )
}

export default GrapeJsEditor
